<!DOCTYPE html>
<html>
<head>
<title>T4A04 Maze by Fred</title>
</head>

<!-- Impostiamo lo sfondo visibile qui -->
<body id="myBody" background="myBackground01.jpg" style="background-repeat: no-repeat; background-size: 800px 600px;">

<h1 align="center"><font color="red">T4A04 Maze by Fred (Pixel Version)</font></h1>

<script>
   // VARIABILI GLOBALI
   let myGlobalX = 0
   let myClock

   // SETUP PER LEGGERE I COLORI (NON TOCCARE)
   // Creiamo un "occhio" invisibile (canvas) per guardare i colori dell'immagine di sfondo
   let myCanvas = document.createElement('canvas');
   let myCtx = myCanvas.getContext('2d');
   let myBackground = new Image();
   
   // CARICA L'IMMAGINE DEL LABIRINTO IN MEMORIA
   myBackground.src = 'myBackground01.jpg'; 
   
   myBackground.onload = function() {
       // Quando l'immagine è pronta, diciamo al canvas quanto è grande
       myCanvas.width = 800;  // Larghezza del gioco
       myCanvas.height = 600; // Altezza del gioco
       // Disegniamo l'immagine nella memoria del computer
       myCtx.drawImage(myBackground, 0, 0, 800, 600);
   };

   // FUNZIONE PER CONTROLLARE SE TOCCHI IL NERO
   function myCheckHit(){
       let player = document.getElementById('myImage01.jpg');
       
       // Calcoliamo il centro del personaggio (più preciso dell'angolo)
       // parseInt trasforma "50px" in 50
       let x = parseInt(player.style.left) + 20; 
       let y = parseInt(player.style.top) + 20; 

       try {
           // Prendi il colore sotto il personaggio
           let pixel = myCtx.getImageData(x, y, 1, 1).data;
           
           // pixel[0] è Rosso, pixel[1] è Verde, pixel[2] è Blu.
           // Se la somma è bassa, il colore è SCURO (Muro)
           let brightness = pixel[0] + pixel[1] + pixel[2];

           // Se brightness è basso (es. meno di 100), è un muro scuro -> RESET
           // Nota: Se il gioco resetta sempre, abbassa questo numero (es. metti < 20)
           if (brightness < 100) { 
               console.log('Hai toccato un muro!');
               // RESET ALLA POSIZIONE DI PARTENZA
               player.style.left = '50px';
               player.style.top = '190px';
           }
           
       } catch(error) {
           // Questo errore appare solo se lo usi in locale senza server. Su GitHub sparirà.
           console.log('Sicurezza Browser (CORS): Impossibile leggere i colori in locale.');
       }
   }

   // FUNZIONE DI MOVIMENTO UNICA
   // Sposta l'immagine e controlla subito se hai sbattuto
   function myMove(dir) {
       let myImg = document.getElementById('myImage01.jpg');
       let currentLeft = parseInt(myImg.style.left);
       let currentTop = parseInt(myImg.style.top);

       if (dir == 'right') {
           myImg.style.left = (currentLeft + 10) + 'px';
       }
       if (dir == 'left') {
           myImg.style.left = (currentLeft - 10) + 'px';
       }
       if (dir == 'up') {
           myImg.style.top = (currentTop - 10) + 'px';
       }
       if (dir == 'down') {
           myImg.style.top = (currentTop + 10) + 'px';
       }

       // Dopo essersi mossi, controlliamo i colori
       myCheckHit();
   }
// Aggiungi l'event listener per la tastiera
document.addEventListener('keydown', function(event) {
    let key = event.key.toLowerCase();
    
    if (key == 'w') {
        myMove('up');
    }
    else if (key == 'a') {
        myMove('left');
    }
    else if (key == 's') {
        myMove('down');
    }
    else if (key == 'd') {
        myMove('right');
    }
});
</script>


<!-- PULSANTI -->
<!-- Ho collegato i pulsanti alla funzione myMove() che è più sicura -->

<div align="center">
    <input type="button" value="Up" ontouchstart="{myMove('up'); event.preventDefault();}" onclick="myMove('up')">
    <br>
    <input type="button" value="Left" ontouchstart="{myMove('left'); event.preventDefault();}" onclick="myMove('left')">
    <input type="button" value="Right" ontouchstart="{myMove('right'); event.preventDefault();}" onclick="myMove('right')">
    <br>
    <input type="button" value="Down" ontouchstart="{myMove('down'); event.preventDefault();}" onclick="myMove('down')">
</div>

<br><br>

<!-- IL TUO PERSONAGGIO -->
<!-- style.left e style.top DEVONO essere scritti qui per funzionare subito -->
<img id="myImage01.jpg" src="myImage01.jpg" style="position:absolute; width:30px; height:30px; left:50px; top:190px; z-index: 10;">

<!-- FINE DEL GIOCO (Esempio) -->
<!-- Puoi lasciare un'immagine traguardo se vuoi -->
<img id="myImg04" src="myImage02.jpg" style="position:absolute; width:50px; height:50px; left:700px; top:400px; opacity: 0.5;">


</body>
</html>
