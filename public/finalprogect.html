<!DOCTYPE html>
<html>
<head>
<title>Labirinto</title>
<style>
body {
  margin: 0;
  background-color: #f0f0f0;
  font-family: Arial;
}
#gameContainer {
  position: relative;
  width: 800px;
  height: 600px;
  margin: 20px auto;
  background-image: url('myBackground01.jpg');
  background-size: cover;
  background-position: center;
  border: 3px solid #333;
}
#player {
  position: absolute;
  width: 15px;
  height: 15px;
  background-color: blue;
  border: 2px solid darkblue;
  border-radius: 3px;
  left: 30px;
  top: 150px;
}
#goal {
  position: absolute;
  width: 40px;
  height: 40px;
  background-color: green;
  border: 3px solid darkgreen;
  border-radius: 5px;
  right: 30px;
  bottom: 30px;
}
#controls {
  text-align: center;
  padding: 20px;
}
button {
  margin: 5px;
  padding: 10px 20px;
  font-size: 16px;
  cursor: pointer;
}
</style>
</head>
<body>
<h1 style="text-align: center; color: red;">T4A04 Maze by Fred</h1>

<div id="controls">
  <div style="margin-bottom: 10px;">
    <strong>Usa i pulsanti o la tastiera: W A S D oppure ‚Üë ‚Üê ‚Üì ‚Üí</strong>
  </div>
  <div>
    <button onclick="move(0, -3)">‚Üë Up (W)</button>
  </div>
  <div>
    <button onclick="move(-3, 0)">‚Üê Left (A)</button>
    <button onclick="move(0, 3)">‚Üì Down (S)</button>
    <button onclick="move(3, 0)">‚Üí Right (D)</button>
  </div>
</div>

<div id="gameContainer">
  <canvas id="canvas" width="800" height="600" style="position: absolute; top: 0; left: 0; display: none; pointer-events: none;"></canvas>
  <div id="player"></div>
  <div id="goal"></div>
</div>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d', { willReadFrequently: true });
const player = document.getElementById('player');
const goal = document.getElementById('goal');
const startX = 30, startY = 150;

let imageLoaded = false;

// Carica l'immagine
const img = new Image();
img.crossOrigin = "anonymous";
img.onload = function() {
  ctx.drawImage(img, 0, 0, 800, 600);
  imageLoaded = true;
  console.log("‚úì Immagine caricata!");
};
img.onerror = function() {
  console.log("‚úó ERRORE: Immagine non trovata!");
  alert("Immagine myBackground01.jpg non trovata!");
};
img.src = 'myBackground01.jpg';

// Controlla se il punto √® su un muro nero
function isWall(x, y) {
  if (!imageLoaded) return false;
  if (x < 0 || x >= 800 || y < 0 || y >= 600) return true;
  
  try {
    const pixel = ctx.getImageData(x, y, 1, 1).data;
    const brightness = (pixel[0] + pixel[1] + pixel[2]) / 3;
    // Solo il NERO vero √® muro
    return brightness < 80;
  } catch(e) {
    return false;
  }
}

// Controlla collisione con area del giocatore
function checkCollision(x, y) {
  const size = 15;
  const checkPoints = [
    [x, y], [x+size, y], [x, y+size], [x+size, y+size],
    [x+size/2, y], [x, y+size/2], [x+size, y+size/2], [x+size/2, y+size],
    [x+size/2, y+size/2]
  ];
  
  for (let [px, py] of checkPoints) {
    if (isWall(Math.floor(px), Math.floor(py))) {
      return true;
    }
  }
  return false;
}

// Muove il giocatore
function move(dx, dy) {
  console.log("MOVE chiamato:", dx, dy);
  
  if (!imageLoaded) {
    console.log("Immagine non ancora caricata, muovo comunque...");
  }
  
  let currentX = parseInt(player.style.left);
  let currentY = parseInt(player.style.top);
  
  // Se NaN, usa la posizione iniziale
  if (isNaN(currentX)) currentX = startX;
  if (isNaN(currentY)) currentY = startY;
  
  console.log("Posizione attuale:", currentX, currentY);
  
  const newX = currentX + dx;
  const newY = currentY + dy;
  console.log("Nuova posizione:", newX, newY);
  
  // Se l'immagine √® caricata, controlla i muri
  if (imageLoaded && checkCollision(newX, newY)) {
    console.log("MURO! Torno all'inizio");
    player.style.left = startX + 'px';
    player.style.top = startY + 'px';
    return;
  }
  
  // Muovi
  player.style.left = newX + 'px';
  player.style.top = newY + 'px';
  console.log("Mosso a:", newX, newY);
  
  // Controlla vittoria
  checkWin();
}

// Controlla se ha raggiunto il traguardo
function checkWin() {
  const px = parseInt(player.style.left);
  const py = parseInt(player.style.top);
  const gx = parseInt(goal.style.left || (800 - 70));
  const gy = parseInt(goal.style.top || (600 - 70));
  
  if (Math.abs(px - gx) < 30 && Math.abs(py - gy) < 30) {
    alert("üéâ HAI VINTO!");
    player.style.left = startX + 'px';
    player.style.top = startY + 'px';
  }
}

// Controllo tastiera (WASD e frecce)
document.addEventListener('keydown', function(e) {
  e.preventDefault(); // Previene lo scroll della pagina
  if (e.key === 'ArrowUp' || e.key === 'w' || e.key === 'W') move(0, -3);
  if (e.key === 'ArrowDown' || e.key === 's' || e.key === 'S') move(0, 3);
  if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') move(-3, 0);
  if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') move(3, 0);
});

console.log("‚úì Gioco pronto! Usa WASD o frecce per muoverti");
</script>

</body>
</html>
