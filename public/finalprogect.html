<!DOCTYPE html>
<html>
<head>
    <title>Maze by Fred - Pixel Version</title>
</head>

<body id="myBody" style="background-color: #cccccc;">

<h1 align="center"><font color="red">T4A04 Maze Pixel Collision</font></h1>

<script>
   // VARIABILI GLOBALI
   let myGlobalX = 0;
   let myClock;
   
   // Creiamo un canvas in memoria per leggere i pixel dell'immagine
   let canvas = document.createElement('canvas');
   let ctx = canvas.getContext('2d');
   let mazeImg = new Image();
   
   // IMPORTANTE: Sostituisci 'maze.jpg' con il nome della tua immagine del labirinto
   // L'immagine deve avere i muri NERI e il percorso BIANCO/CHIARO
   mazeImg.src = 'maze.jpg'; 
   
   mazeImg.onload = function() {
       // Quando l'immagine è carica, ridimensioniamo il canvas e la disegniamo
       canvas.width = mazeImg.width;
       canvas.height = mazeImg.height;
       ctx.drawImage(mazeImg, 0, 0, mazeImg.width, mazeImg.height);
       
       // Impostiamo l'immagine anche come sfondo visibile del div contenitore
       document.getElementById('myMazeDiv').style.backgroundImage = "url('" + mazeImg.src + "')";
       document.getElementById('myMazeDiv').style.width = mazeImg.width + "px";
       document.getElementById('myMazeDiv').style.height = mazeImg.height + "px";
   };

   // FUNZIONE DI CONTROLLO COLORE
   function myCheckPixel(){
      let player = document.getElementById('myImg01');
      
      // Otteniamo la posizione del giocatore
      // Aggiungiamo +50 e +40 per controllare il CENTRO del giocatore, non l'angolo in alto a sinistra
      let x = parseInt(player.style.left) + 25; 
      let y = parseInt(player.style.top) + 25; 

      // Leggiamo il colore del pixel in quella posizione (R, G, B, Alpha)
      try {
          let pixelData = ctx.getImageData(x, y, 1, 1).data;
          let red = pixelData[0];
          let green = pixelData[1];
          let blue = pixelData[2];

          // Calcoliamo la luminosità (media dei colori)
          // Se è vicino a 0 è nero/scuro. Se è vicino a 255 è bianco.
          let brightness = (red + green + blue) / 3;

          // SE IL COLORE E' SCURO (Muro) -> RESET
          if (brightness < 100) { 
             console.log("Muro colpito! Luminosità: " + brightness);
             // Reset posizione
             player.style.left = '20px';
             player.style.top = '20px';
          }
          
          // SE IL COLORE E' VERDE O ROSSO PURO (Opzionale: Vittoria)
          // Esempio: se c'è un pixel verde puro (R<50, G>200, B<50) vinci
          if (red < 50 && green > 200 && blue < 50) {
              alert("You Win!");
              location.reload();
          }

      } catch (e) {
          // Questo errore appare se testi il file in locale senza un server (CORS issue)
          console.log("Errore lettura pixel (probabilmente CORS): " + e);
      }
   }

   // Movimento
   function move(dir) {
       let player = document.getElementById('myImg01');
       let step = 10;
       
       if(dir == 'right') player.style.left = parseInt(player.style.left) + step + 'px';
       if(dir == 'left')  player.style.left = parseInt(player.style.left) - step + 'px';
       if(dir == 'down')  player.style.top  = parseInt(player.style.top) + step + 'px';
       if(dir == 'up')    player.style.top  = parseInt(player.style.top) - step + 'px';
       
       myCheckPixel();
   }

</script>

<div align="center">
    <input type="button" value="Up" onclick="move('up')"><br>
    <input type="button" value="Left" onclick="move('left')">
    <input type="button" value="Right" onclick="move('right')">
    <input type="button" value="Down" onclick="move('down')">
</div>

<br>

<div id="myMazeDiv" style="position:relative; margin: 0 auto; border: 2px solid black;">
    
    <img id="myImg01" src="https://upload.wikimedia.org/wikipedia/commons/2/22/Earth_Western_Hemisphere_transparent_background.png" 
         style="position:absolute; width:50px; height:50px; left:20px; top:20px; z-index:10;">

</div>

<p align="center">Nota: I muri devono essere neri o molto scuri nell'immagine.</p>

</body>
</html>
